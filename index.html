<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReCSSolution: Poly-unit Viewport Ruler</title>
    <style>
        /* CSS Variables */
        :root {
            color-scheme: light dark;

            /* Color palette */
            --gray-0: #ffffff;
            --gray-1: #f2f4f8;
            --gray-1h: #e4e9f1;
            --gray-2: #dde1e6;
            --gray-3: #c1c7cd;
            --gray-4: #a2a9b0;
            --gray-5: #878d96;
            --gray-6: #697077;
            --gray-7: #4d5358;
            --gray-8: #343a3f;
            --gray-9: #21272a;
            --gray-9h: #2b3236;

            --gray-10: #121619;

            /* Theme color mapping */
            --bg-0-10: light-dark(var(--gray-0), var(--gray-10));
            --bg-1-9: light-dark(var(--gray-1), var(--gray-9));
            --bg-1h-9h: light-dark(var(--gray-1h), var(--gray-9h));
            --fg-2-7: light-dark(var(--gray-2), var(--gray-7));
            --fg-3-7: light-dark(var(--gray-3), var(--gray-7));
            --fg-3-5: light-dark(var(--gray-3), var(--gray-5));
            --fg-4-5: light-dark(var(--gray-4), var(--gray-5));
            --fg-7-1: light-dark(var(--gray-7), var(--gray-1));
            --fg-7-4: light-dark(var(--gray-7), var(--gray-4));

            /* Typography */
            --type-family-sans: system-ui, sans-serif;
            --type-family-mono: ui-monospace, monospace;
            --type-scale-body: clamp(0.875rem, 0.8036rem + 0.3571vw, 1.125rem);
            --type-scale-functional: clamp(0.75rem, 0.7143rem + 0.1786vw, 0.875rem);
            --type-tracking-scaps-slight: 0.075ex;
            --type-tracking-body-slight: 0.010rem;

            /* Spacing */
            --space-1-2: clamp(0.25rem, 0.2143rem + 0.1786vw, 0.375rem);
            --space-3: 0.375rem;
            --space-4: 0.5rem;
            --space-3-4: clamp(0.375rem, 0.3393rem + 0.1786vw, 0.5rem);
            --space-3-5: clamp(0.375rem, 0.1964rem + 0.8929vw, 1rem);
            --space-5-6: clamp(1rem, 0.8571rem + 0.7143vw, 1.5rem);

            /* Z-index layers */
            --layer-1: 1;
            --layer-2: 2;

            /* Component styling */
            --corner: var(--space-4);
            --ease-in-out-circular: cubic-bezier(0.785, 0.135, 0.15, 0.86);
            --stroke: 5px;
            --arrowhead: url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22800%22%20height%3D%22800%22%20fill%3D%22none%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20fill%3D%22%234d5358%22%20d%3D%22M7.82%2020.731a1%201%200%200%200%201.415%200l6.644-6.644a3%203%200%200%200%20.001-4.242L9.31%203.27a1%201%200%201%200-1.415%201.414l6.572%206.572a1%201%200%200%201%200%201.414l-6.646%206.647a1%201%200%200%200%200%201.414Z%22%2F%3E%3C%2Fsvg%3E");
        }

        /* Light mode arrowhead */
        @media (prefers-color-scheme: light) {
            :root {
                --arrowhead: url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22800%22%20height%3D%22800%22%20fill%3D%22none%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20fill%3D%22%23dde1e6%22%20d%3D%22M7.82%2020.731a1%201%200%200%200%201.415%200l6.644-6.644a3%203%200%200%200%20.001-4.242L9.31%203.27a1%201%200%201%200-1.415%201.414l6.572%206.572a1%201%200%200%201%200%201.414l-6.646%206.647a1%201%200%200%200%200%201.414Z%22%2F%3E%3C%2Fsvg%3E");
            }
        }

        /* Reset */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 100%;
            min-block-size: 100dvh;
            text-size-adjust: none;
            -moz-text-size-adjust: none;
            -webkit-text-size-adjust: none;
            accent-color: cornflowerblue;
        }

        body {
            background-color: var(--bg-0-10);
            font-family: var(--type-family-mono);
            font-size: var(--type-scale-body);
            min-block-size: 100dvh;
            min-inline-size: 100dvw;
            overflow: hidden;
        }

        /* Main container */
        main {
            z-index: var(--layer-2);
        }

        section {
            color: var(--fg-7-1);
            background-color: var(--bg-1-9);
            border: var(--stroke) solid var(--fg-2-7);
            border-radius: var(--corner);
            padding-block: var(--space-3-4);
            padding-inline: var(--space-5-6);
        }

        /* Typography */
        :where(h1, h2, thead) {
            font-size: inherit;
            font-weight: normal;
        }

        :where(h1, h2, caption, thead th, label, footer) {
            color: var(--fg-7-4);
            font-family: var(--type-family-sans);
            font-weight: normal;
        }

        /* Table styling */
        table {
            border-collapse: collapse;
            table-layout: auto;
        }

        thead {
            border-block-end: 1.5px solid var(--fg-3-7);
            font-variant-caps: all-small-caps;
            letter-spacing: var(--type-tracking-scaps-slight);
            text-align: left;
            vertical-align: bottom;
        }

        thead th:first-of-type {
            text-align: right;
        }

        :where(td, th) {
            border-bottom: 1px solid var(--fg-3-7);
            padding-block: var(--space-3);
            padding-inline: var(--space-1-2);
            vertical-align: baseline;
        }

        /* Row hover effect */
        tbody tr {
            transition: background-color 420ms var(--ease-in-out-circular);
        }

        tbody tr:not(:first-of-type):hover {
            background-color: var(--bg-1h-9h);
            transition: background-color 60ms var(--ease-in-out-circular);
        }

        /* &times; sign and label */
        tbody tr td:nth-child(2) {
            color: var(--fg-7-4);
        }

        /* Terminal rows no border */
        :where(thead td, tbody tr:last-of-type>*) {
            border-bottom: none;
        }

        /* Form elements */
        label {
            text-wrap: nowrap;
            margin-inline-start: -17px;
        }

        input {
            margin-inline-end: var(--space-3);
            vertical-align: middle;
        }

        /* Footer */
        footer {
            bottom: var(--space-3-5);
            position: absolute;
            width: 100vw;
            z-index: var(--layer-1);
        }

        footer span {
            color: var(--fg-4-5);
            background-color: var(--bg-0-10);
            font-size: var(--type-scale-functional);
            letter-spacing: var(--type-tracking-body-slight);
        }

        /* Layout primitives */
        .center {
            box-sizing: content-box;
            margin-inline: auto;
            max-inline-size: var(--measure, 22ch);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .cover {
            display: flex;
            flex-direction: column;
            min-block-size: 100vh;
            padding: var(--space-3);
        }

        .cover>* {
            margin-block: 0;
        }

        .cover> :first-child:not(main) {
            margin-block-start: 0;
        }

        .cover> :last-child:not(main) {
            margin-block-end: 0;
        }

        .cover>main {
            margin-block: auto;
        }

        .stack-x {
            display: flex;
            flex-wrap: nowrap;
            gap: var(--space-4);
            justify-content: space-around;
            align-items: center;
        }

        /* Utilities */
        .zed {
            color: var(--fg-4-5);
        }

        .sc {
            font-variant-caps: all-small-caps;
        }

        /* Visually hidden */
        .vh {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Axes */
        .axis {
            position: absolute;
            background-color: var(--fg-2-7);
            background-position: center;
            top: 50%;
            left: 50%;
            translate: -50% -50%;
        }

        .axis::before,
        .axis::after {
            content: "";
            --size: 65px;
            width: var(--size);
            height: var(--size);
            position: absolute;
            --axis-offset: calc(-1 * var(--size) / 2 + var(--stroke) / 2);
            --edge-offset: calc(-1 * var(--size) / 3);
            background-image: var(--arrowhead);
            background-position: center;
            background-size: cover;
        }

        .x.axis {
            width: calc(100% - 2 * var(--stroke));
            height: var(--stroke);
        }

        .y.axis {
            height: calc(100% - 2 * var(--stroke));
            width: var(--stroke);
        }

        .x.axis::before {
            top: var(--axis-offset);
            left: var(--edge-offset);
            rotate: 180deg;
        }

        .x.axis::after {
            top: var(--axis-offset);
            right: var(--edge-offset);
        }

        .y.axis::before {
            left: var(--axis-offset);
            top: var(--edge-offset);
            rotate: -90deg;
        }

        .y.axis::after {
            left: var(--axis-offset);
            bottom: var(--edge-offset);
            rotate: 90deg;
        }
    </style>
    <meta name="author" content="Timothy Martens">
    <meta name="description" content="ReCSSolution: Poly-unit Viewport Ruler">
</head>

<body class="cover">
    <main>
        <section class="center">
            <h1 class="vh">ReCSSolution: Poly-unit Viewport Ruler</h1>
            <table>
                <caption class="vh">CSS Relative &amp; Absolute Length Units</caption>
                <thead>
                    <tr>
                        <th scope="col">Width</th>
                        <th scope="col">&times;</th>
                        <th scope="col">Height</th>
                        <th scope="col">Unit</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="3">
                            <h2>relative units</h2>
                        </td>
                        <td>
                            <label>
                                <input type="checkbox" id="root-toggle">root
                            </label>
                        </td>
                    </tr>
                    <tr class="relative-unit">
                        <td id="cap-width">000.00</td>
                        <td>&times;</td>
                        <td id="cap-height">000.00</td>
                        <td id="cap-unit"><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/length#cap">cap</a></td>
                    </tr>
                    <tr class="relative-unit">
                        <td id="ch-width">000.00</td>
                        <td>&times;</td>
                        <td id="ch-height">000.00</td>
                        <td id="ch-unit"><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/length#ch">ch</a></td>
                    </tr>
                    <tr class="relative-unit">
                        <td id="em-width">000.00</td>
                        <td>&times;</td>
                        <td id="em-height">000.00</td>
                        <td id="em-unit"><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/length#em">em</a></td>
                    </tr>
                    <tr class="relative-unit">
                        <td id="ex-width">000.00</td>
                        <td>&times;</td>
                        <td id="ex-height">000.00</td>
                        <td id="ex-unit"><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/length#ex">ex</a></td>
                    </tr>
                    <tr class="relative-unit">
                        <td id="ic-width">000.00</td>
                        <td>&times;</td>
                        <td id="ic-height">000.00</td>
                        <td id="ic-unit"><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/length#ic">ic</a></td>
                    </tr>
                    <tr class="relative-unit">
                        <td id="lh-width">000.00</td>
                        <td>&times;</td>
                        <td id="lh-height">000.00</td>
                        <td id="lh-unit"><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/length#lh">lh</a></td>
                    </tr>
                </tbody>
                <tbody>
                    <tr>
                        <td colspan="3">
                            <h2>absolute units</h2>
                        </td>
                        <td colspan="1">
                        </td>
                    </tr>
                    <tr>
                        <td id="px-width">000.00</td>
                        <td>&times;</td>
                        <td id="px-height">000.00</td>
                        <td><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/length#px">px</a></td>
                    </tr>
                    <tr>
                        <td id="cm-width">000.00</td>
                        <td>&times;</td>
                        <td id="cm-height">000.00</td>
                        <td><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/length#cm">cm</a></td>
                    </tr>
                    <tr>
                        <td id="mm-width">000.00</td>
                        <td>&times;</td>
                        <td id="mm-height">000.00</td>
                        <td><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/length#mm">mm</a></td>
                    </tr>
                    <tr>
                        <td id="q-width">000.00</td>
                        <td>&times;</td>
                        <td id="q-height">000.00</td>
                        <td><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/length#q">Q</a></td>
                    </tr>
                    <tr>
                        <td id="in-width">000.00</td>
                        <td>&times;</td>
                        <td id="in-height">000.00</td>
                        <td><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/length#in">in</a></td>
                    </tr>
                    <tr>
                        <td id="pc-width">000.00</td>
                        <td>&times;</td>
                        <td id="pc-height">000.00</td>
                        <td><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/length#pc">pc</a></td>
                    </tr>
                    <tr>
                        <td id="pt-width">000.00</td>
                        <td>&times;</td>
                        <td id="pt-height">000.00</td>
                        <td><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/length#pt">pt</a></td>
                    </tr>
                </tbody>
            </table>
        </section>
    </main>

    <footer class="stack-x">
        <span><span class="sc">R</span>e<abbr title="Cascading Style Sheets" class="sc">CSS</abbr>olution</span><span>&copy;&apos;25 Timothy Martens</span>
    </footer>

    <div class="x axis"></div>
    <div class="y axis"></div>

    <script>
        /**
         * Unit Measurement Display Application
         * Displays window dimensions in various CSS units with performance optimizations
         */
        class UnitMeasurementDisplay {
            constructor() {
                // Standard DPI conversion values
                this.DPI_STANDARD = 96; // 96px = 1 inch

                // Unit names for toggling between regular and root-relative
                this.relativeUnits = ['cap', 'ch', 'em', 'ex', 'ic', 'lh'];

                // Absolute units - won't be affected by root toggle
                this.absoluteUnits = ['px', 'cm', 'mm', 'q', 'in', 'pc', 'pt'];

                // Cache for unit measurement elements
                this.unitElements = {};

                // Cache measurements to avoid unnecessary DOM operations
                this.cachedMeasurements = {};

                // DOM elements
                this.rootToggle = document.getElementById('root-toggle');

                // Create and cache the measuring element
                this.measuringElement = this.createMeasuringElement();

                // Cache all DOM elements that we'll update
                this.cacheElements();

                // Debounce timer reference
                this.resizeTimer = null;
                this.debounceDelay = 100; // ms - reduced from 150ms for better responsiveness

                // Device pixel ratio
                this.devicePixelRatio = window.devicePixelRatio || 1;

                // Feature detection results
                this.supportedFeatures = this.detectFeatures();

                // Last window dimensions to prevent unnecessary updates
                this.lastWidth = 0;
                this.lastHeight = 0;

                // Bind methods to preserve 'this' context
                this.updateSize = this.updateSize.bind(this);
                this.debouncedResize = this.debouncedResize.bind(this);
                this.toggleRootRelativeUnits = this.toggleRootRelativeUnits.bind(this);

                // Initialize
                this.init();
            }

            /**
             * Initialize the application
             */
            init() {
                try {
                    // Set up event listeners
                    window.addEventListener('resize', this.debouncedResize, { passive: true });
                    this.rootToggle.addEventListener('change', this.toggleRootRelativeUnits);

                    // Listen for device pixel ratio changes (some browsers support this)
                    if (window.matchMedia) {
                        window.matchMedia('(resolution)').addEventListener('change', this.debouncedResize, { passive: true });
                    }

                    // Pre-calculate unit measurements for improved performance
                    this.precalculateUnitFactors();

                    // Initial update
                    this.updateSize();

                    console.log('ReCSSolution: Initialized successfully');
                } catch (error) {
                    console.error('ReCSSolution: Initialization failed', error);
                    this.handleError(error);
                }
            }

            /**
             * Cache all DOM elements we'll need to update
             */
            cacheElements() {
                // Cache all unit display elements
                const allUnits = [...this.relativeUnits, ...this.absoluteUnits];

                allUnits.forEach(unit => {
                    this.unitElements[`${unit}-width`] = document.getElementById(`${unit}-width`);
                    this.unitElements[`${unit}-height`] = document.getElementById(`${unit}-height`);
                    this.unitElements[`${unit}-unit`] = document.getElementById(`${unit}-unit`);
                });
            }

            /**
             * Create and return a measuring element
             * @returns {HTMLElement} The measuring element
             */
            createMeasuringElement() {
                const element = document.createElement('div');
                element.style.cssText = 'visibility:hidden;position:absolute;font-family:monospace;pointer-events:none;left:-9999px;';
                element.setAttribute('aria-hidden', 'true');
                document.body.appendChild(element);
                return element;
            }

            /**
             * Detect browser feature support
             * @returns {Object} Object containing feature detection results
             */
            detectFeatures() {
                return {
                    resizeObserver: typeof ResizeObserver !== 'undefined',
                    devicePixelRatio: typeof window.devicePixelRatio !== 'undefined',
                    supportsCap: this.testUnitSupport('cap'),
                    supportsIc: this.testUnitSupport('ic'),
                    supportsLh: this.testUnitSupport('lh')
                };
            }

            /**
             * Test if a CSS unit is supported by the browser
             * @param {string} unit - The CSS unit to test
             * @returns {boolean} Whether the unit is supported
             */
            testUnitSupport(unit) {
                try {
                    this.measuringElement.style.width = `1${unit}`;
                    return this.measuringElement.getBoundingClientRect().width > 0;
                } catch (e) {
                    return false;
                } finally {
                    this.measuringElement.style.width = '';
                }
            }

            /**
             * Pre-calculate unit conversion factors
             */
            precalculateUnitFactors() {
                // Calculate once for regular units
                this.cachedMeasurements.regular = this.getUnitMeasurements(false);

                // Calculate once for root units
                this.cachedMeasurements.root = this.getUnitMeasurements(true);
            }

            /**
             * Handle errors gracefully
             * @param {Error} error - The error object
             */
            handleError(error) {
                // Log the error
                console.error('ReCSSolution Error:', error);
            }

            /**
             * Debounced window resize handler
             */
            debouncedResize() {
                // Cancel any pending updates
                if (this.resizeTimer) {
                    cancelAnimationFrame(this.resizeTimer);
                }

                // Request animation frame for smooth updates
                this.resizeTimer = requestAnimationFrame(() => {
                    // Check if device pixel ratio has changed
                    const newRatio = window.devicePixelRatio || 1;
                    if (newRatio !== this.devicePixelRatio) {
                        this.devicePixelRatio = newRatio;
                        // Recalculate if DPR changed
                        this.precalculateUnitFactors();
                    }

                    this.updateSize();
                });
            }

            /**
             * Update all dimension values
             */
            updateSize() {
                try {
                    // Get accurate window dimensions
                    const width = window.innerWidth;
                    const height = window.innerHeight;

                    // Skip update if dimensions haven't changed
                    if (width === this.lastWidth && height === this.lastHeight) {
                        return;
                    }

                    // Update last dimensions
                    this.lastWidth = width;
                    this.lastHeight = height;

                    // Get measurements based on toggle state
                    const useRootElement = this.rootToggle.checked;
                    const measurements = useRootElement ?
                        this.cachedMeasurements.root :
                        this.cachedMeasurements.regular;

                    // Use batch updates for better performance
                    this.batchUpdateDisplay(measurements, width, height);

                } catch (error) {
                    this.handleError(error);
                }
            }

            /**
             * Toggle between regular and root-relative units
             */
            toggleRootRelativeUnits() {
                try {
                    const useRootElement = this.rootToggle.checked;

                    // Update unit names based on toggle state
                    this.relativeUnits.forEach(unit => {
                        const unitElement = this.unitElements[`${unit}-unit`];
                        if (unitElement) {
                            const prefix = useRootElement ? 'r' : '';
                            unitElement.innerHTML = `<a href="https://developer.mozilla.org/en-US/docs/Web/CSS/length#${unit}">${prefix}${unit}</a>`;
                        }
                    });

                    // Update measurements - reuse existing cached measurements
                    this.updateSize();
                } catch (error) {
                    this.handleError(error);
                }
            }

            /**
             * Get unit measurements and conversion factors
             * @param {boolean} useRootElement - Whether to use root element for font measurements
             * @returns {Object} Measurement values and conversion factors
             */
            getUnitMeasurements(useRootElement = false) {
                // Get root font properties
                const rootStyles = window.getComputedStyle(document.documentElement);
                const rootFontSize = parseFloat(rootStyles.fontSize);

                // Set the appropriate font size for the measuring element
                if (useRootElement) {
                    this.measuringElement.style.fontSize = rootFontSize + 'px';
                } else {
                    this.measuringElement.style.fontSize = '';
                }

                // Get the device pixel ratio for more accurate physical measurements
                const dpr = this.devicePixelRatio;

                // Measure relative units
                const measurements = {
                    // Relative units
                    chWidth: this.measureDimension(this.measuringElement, '1ch', 'width'),
                    emWidth: this.measureDimension(this.measuringElement, '1em', 'width'),
                    exHeight: this.measureDimension(this.measuringElement, '1ex', 'height'),
                    capHeight: this.supportedFeatures.supportsCap
                        ? this.measureDimension(this.measuringElement, '1cap', 'height')
                        : this.measureDimension(this.measuringElement, '0.75em', 'height'), // Fallback for unsupported browsers
                    icWidth: this.supportedFeatures.supportsIc
                        ? this.measureDimension(this.measuringElement, '1ic', 'width')
                        : this.measureDimension(this.measuringElement, '1em', 'width'), // Fallback for unsupported browsers
                    lhHeight: this.supportedFeatures.supportsLh
                        ? this.measureDimension(this.measuringElement, '1lh', 'height')
                        : this.measureDimension(this.measuringElement, '1.2em', 'height'), // Fallback for unsupported browsers
                    rootFontSize,

                    // Absolute unit conversion factors adjusted for device pixel ratio
                    pxPerIn: this.DPI_STANDARD * dpr,
                    pxPerCm: (this.DPI_STANDARD / 2.54) * dpr,
                    pxPerMm: (this.DPI_STANDARD / 25.4) * dpr,
                    pxPerQ: (this.DPI_STANDARD / 101.6) * dpr, // 1Q = 1/4mm
                    pxPerPt: (this.DPI_STANDARD / 72) * dpr,
                    pxPerPc: (this.DPI_STANDARD / 6) * dpr // 1pc = 12pt
                };

                return measurements;
            }

            /**
             * Measure a specific dimension of an element with a given CSS unit
             * @param {HTMLElement} element - Element to measure
             * @param {string} value - CSS value to apply
             * @param {string} dimension - Dimension to measure ('width' or 'height')
             * @returns {number} The measured value in pixels
             */
            measureDimension(element, value, dimension) {
                try {
                    element.style[dimension] = value;
                    const result = element.getBoundingClientRect()[dimension];
                    element.style[dimension] = '';
                    return result;
                } catch (error) {
                    this.handleError(error);
                    return 0; // Return a fallback value
                }
            }

            /**
             * Format number for display with styled leading zeros
             * @param {number} num - Number to format
             * @returns {string} HTML string with formatted number
             */
            formatNumber(num) {
                try {
                    // Convert to string with fixed 2 decimal places
                    let formatted = num.toFixed(2);

                    // Split the number at the decimal point
                    const parts = formatted.split('.');

                    // Count leading zeros needed
                    let leadingZeros = '';
                    for (let i = parts[0].length; i < 4; i++) {
                        leadingZeros += '0';
                    }

                    // Return formatted number with styled leading zeros
                    if (leadingZeros.length > 0) {
                        return `<span class="zed">${leadingZeros}</span>${parts[0].trim()}${parts[1] ? '.' + parts[1] : ''}`;
                    } else {
                        return parts[0] + '.' + parts[1];
                    }
                } catch (error) {
                    this.handleError(error);
                    return '000.00'; // Return a fallback value
                }
            }

            /**
             * Batch update all unit displays for better performance
             * @param {Object} measurements - Unit measurements
             * @param {number} width - Window width
             * @param {number} height - Window height
             */
            batchUpdateDisplay(measurements, width, height) {
                // Create a document fragment for batch DOM updates
                const updateTask = () => {
                    // Update relative units
                    this.relativeUnits.forEach(unit => {
                        let factor;
                        switch (unit) {
                            case 'ch': factor = measurements.chWidth; break;
                            case 'em': factor = measurements.emWidth; break;
                            case 'ex': factor = measurements.exHeight; break;
                            case 'cap': factor = measurements.capHeight; break;
                            case 'ic': factor = measurements.icWidth; break;
                            case 'lh': factor = measurements.lhHeight; break;
                        }

                        if (factor > 0) {
                            this.updateElementInnerHTML(`${unit}-width`, this.formatNumber(width / factor));
                            this.updateElementInnerHTML(`${unit}-height`, this.formatNumber(height / factor));
                        }
                    });

                    // Update pixel values directly
                    this.updateElementInnerHTML('px-width', this.formatNumber(width));
                    this.updateElementInnerHTML('px-height', this.formatNumber(height));

                    // Update absolute units
                    this.updateElementInnerHTML('cm-width', this.formatNumber(width / measurements.pxPerCm));
                    this.updateElementInnerHTML('cm-height', this.formatNumber(height / measurements.pxPerCm));

                    this.updateElementInnerHTML('mm-width', this.formatNumber(width / measurements.pxPerMm));
                    this.updateElementInnerHTML('mm-height', this.formatNumber(height / measurements.pxPerMm));

                    this.updateElementInnerHTML('q-width', this.formatNumber(width / measurements.pxPerQ));
                    this.updateElementInnerHTML('q-height', this.formatNumber(height / measurements.pxPerQ));

                    this.updateElementInnerHTML('in-width', this.formatNumber(width / measurements.pxPerIn));
                    this.updateElementInnerHTML('in-height', this.formatNumber(height / measurements.pxPerIn));

                    this.updateElementInnerHTML('pc-width', this.formatNumber(width / measurements.pxPerPc));
                    this.updateElementInnerHTML('pc-height', this.formatNumber(height / measurements.pxPerPc));

                    this.updateElementInnerHTML('pt-width', this.formatNumber(width / measurements.pxPerPt));
                    this.updateElementInnerHTML('pt-height', this.formatNumber(height / measurements.pxPerPt));
                };

                // Use requestAnimationFrame for better performance
                requestAnimationFrame(updateTask);
            }

            /**
             * Helper method to safely update innerHTML with cached elements
             * @param {string} id - Element ID
             * @param {string} html - HTML content
             */
            updateElementInnerHTML(id, html) {
                const element = this.unitElements[id];
                if (element) {
                    element.innerHTML = html;
                }
            }

            /**
             * Clean up resources to prevent memory leaks
             */
            cleanup() {
                try {
                    // Remove event listeners
                    window.removeEventListener('resize', this.debouncedResize);
                    this.rootToggle.removeEventListener('change', this.toggleRootRelativeUnits);

                    if (window.matchMedia) {
                        window.matchMedia('(resolution)').removeEventListener('change', this.debouncedResize);
                    }

                    // Clear any pending timers
                    if (this.resizeTimer) {
                        cancelAnimationFrame(this.resizeTimer);
                        this.resizeTimer = null;
                    }

                    // Remove the measuring element
                    if (this.measuringElement && this.measuringElement.parentNode) {
                        this.measuringElement.parentNode.removeChild(this.measuringElement);
                    }

                    console.log('ReCSSolution: Cleanup completed');
                } catch (error) {
                    console.error('ReCSSolution: Cleanup error', error);
                }
            }
        }

        // Initialize the application when the document is loaded
        document.addEventListener('DOMContentLoaded', () => {
            const app = new UnitMeasurementDisplay();

            // Store the instance in a global variable for potential cleanup
            window.recssolution = app;

            // Add cleanup on page unload
            window.addEventListener('beforeunload', () => {
                if (window.recssolution) {
                    window.recssolution.cleanup();
                }
            });
        });
    </script>
</body>

</html>
